- name: Run Duo install as part of Host configuration for User Mgmt
  hosts: control-center
  become: true
  become_method: sudo

  vars:
      duo_env_path: 'ansible-control-center/config/generated/post-vm-creation/duo.env'
      state_file: 'ansible-control-center/config/generated/post-vm-creation/vm.state'
      duo_ikey: "{{ lookup('env','duo_ikey') }}"
      duo_skey: "{{ lookup('env','duo_skey') }}"
      duo_api_host: "{{ lookup('env','duo_api_host') }}"
      duo_pam_groups: ['deployer', 'sudo']
      duo_pam_prompts: 3

      # users_group_add_list:
      #   - name: deployer
      #     groups: [ "sudo" ]
      users_add_list:
        - name: "{{ lookup('env','cec_user') }}"
          unlimited_superuser: true
          comment: "MFA Enabled CEC User for IaaC Mgmt"
          ssh_key: "{{ lookup('env','ssh_key') }}"
          groups: ['sudo','deployer']
          # limited_superuser_commands:
          #   - /bin/vi
      # users_delete_list:
      #   -name: ubuntu


  pre_tasks:
      - name: Display State File
        shell: 'cat {{ state_file }} '
        register: state_file_output
      - debug: var=state_file_output.stdout

  roles:
      - role: ansible-users
      # - role: ansible-duo_install
